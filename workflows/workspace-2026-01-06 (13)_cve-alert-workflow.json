{
  "name": "CyberSentinel - Critical CVE Alert Workflow",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyX",
              "everyX": 1,
              "unit": "hours"
            }
          ]
        },
        "url": "https://nvd.nist.gov/feeds/json/cve/1.1/nvdcve-1.1-recent.json.zip"
      },
      "name": "NVD CVE Feed Trigger",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        100,
        200
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "cve-feed-auth",
          "name": "NVD Feed Auth"
        }
      }
    },
    {
      "parameters": {
        "url": "https://cisa.gov/api/v1/advisories/recent"
      },
      "name": "CISA KEV Feed",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        300,
        200
      ]
    },
    {
      "parameters": {
        "functionCode": "\nconst cveItems = items;\nconst results = [];\n\nfor (const item of cveItems) {\n  const cveData = item.json;\n  const cveId = cveData.cve?.CVE_data_meta?.ID || 'UNKNOWN';\n  const description = cveData.cve?.description?.description_data?.[0]?.value || 'No description';\n  const cvss = cveData.impact?.baseMetricV3?.cvssV3?.baseScore || 0;\n  const publishedDate = cveData.publishedDate || new Date().toISOString();\n  \n  // Extract affected products\n  const vendor = cveData.affects?.vendor?.vendor_data?.[0]?.vendor_name || 'Unknown';\n  const products = cveData.affects?.vendor?.vendor_data?.[0]?.product?.product_data?.map(p => p.product_name) || [];\n  \n  // Determine severity\n  let severity = 'LOW';\n  if (cvss >= 9.0) severity = 'CRITICAL';\n  else if (cvss >= 7.0) severity = 'HIGH';\n  else if (cvss >= 4.0) severity = 'MEDIUM';\n  \n  // Check for known exploited status\n  const isActivelyExploited = cveData.knownRaiActivity?.value === 'ACTUAL' || false;\n  \n  results.push({\n    json: {\n      threatType: 'VULNERABILITY',\n      threatId: cveId,\n      title: `${cveId}: ${description.substring(0, 100)}...`,\n      description: description,\n      severity: severity,\n      cvss: cvss,\n      affectedSystems: {\n        vendor: vendor,\n        products: products,\n        platforms: cveData.platform_version?.platform_version_data?.map(p => p.platform_version) || []\n      },\n      indicatorsOfCompromise: {\n        cveId: cveId,\n        cwe: cveData.weaknessCWE?.description?.map(w => w.value) || [],\n        references: cveData.references?.map(r => r.url) || [],\n        isActivelyExploited: isActivelyExploited\n      },\n      recommendedActions: getRemediationActions(cveId, severity, cvss),\n      source: 'NVD',\n      publishedDate: publishedDate,\n      processedAt: new Date().toISOString()\n    }\n  });\n}\n\nfunction getRemediationActions(cveId, severity, cvss) {\n  const actions = [\n    {\n      priority: 1,\n      action: 'ASSESS',\n      description: 'Identify affected assets in environment',\n      timeline: '24 hours',\n      automated: true\n    },\n    {\n      priority: 2,\n      action: 'PATCH',\n      description: 'Apply vendor patches or mitigations',\n      timeline: severity === 'CRITICAL' ? '48 hours' : '7 days',\n      automated: false\n    }\n  ];\n  \n  if (severity === 'CRITICAL' || cvss >= 9.0) {\n    actions.push({\n      priority: 3,\n      action: 'CONTAIN',\n      description: 'Implement compensating controls if patch unavailable',\n      timeline: '24 hours',\n      automated: true\n    });\n  }\n  \n  return actions;\n}\n\nreturn results;\n"
      },
      "name": "Parse CVE Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        500,
        200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.severity }}",
              "operation": "equal",
              "value2": "CRITICAL"
            }
          ]
        }
      },
      "name": "Filter Critical CVEs",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        700,
        200
      ]
    },
    {
      "parameters": {
        "channel": "security-alerts",
        "blocks": [
          {
            "type": "section",
            "text": {
              "type": "mrkdwn",
              "text": "ðŸš¨ *CRITICAL CVE ALERT*\n\n*Threat:* {{ $json.title }}\n*Severity:* {{ $json.severity }}\n*CVSS Score:* {{ $json.cvss }}\n*Affected:* {{ $json.affectedSystems.vendor }} - {{ $json.affectedSystems.products.join(', ') }}\n\n*Recommended Actions:*\n{{ $json.recommendedActions.map(a => `â€¢ *${a.action}* (${a.timeline}): ${a.description}`).join('\\n') }}\n\n*References:*\n{{ $json.indicatorsOfCompromise.references.slice(0, 3).join('\\n') }}"
            }
          }
        ],
        "attachments": []
      },
      "name": "Slack Alert - Critical",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [
        900,
        100
      ],
      "credentials": {
        "slackApi": {
          "id": "slack-security-alerts",
          "name": "Security Alerts Slack"
        }
      }
    },
    {
      "parameters": {
        "channel": "security-alerts",
        "blocks": [
          {
            "type": "section",
            "text": {
              "type": "mrkdwn",
              "text": "âš ï¸ *New CVE Detected*\n\n*ID:* {{ $json.threatId }}\n*Severity:* {{ $json.severity }}\n*Score:* {{ $json.cvss }}\n*Vendor:* {{ $json.affectedSystems.vendor }}"
            }
          }
        ]
      },
      "name": "Slack Alert - Standard",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [
        900,
        300
      ],
      "credentials": {
        "slackApi": {
          "id": "slack-security-alerts",
          "name": "Security Alerts Slack"
        }
      }
    },
    {
      "parameters": {
        "operation": "upsert",
        "fields": {
          "threatId": "={{ $json.threatId }}",
          "threatType": "={{ $json.threatType }}",
          "title": "={{ $json.title }}",
          "description": "={{ $json.description }}",
          "severity": "={{ $json.severity }}",
          "cvss": "={{ $json.cvss }}",
          "affectedSystems": "={{ JSON.stringify($json.affectedSystems) }}",
          "indicatorsOfCompromise": "={{ JSON.stringify($json.indicatorsOfCompromise) }}",
          "recommendedActions": "={{ JSON.stringify($json.recommendedActions) }}",
          "source": "={{ $json.source }}",
          "processedAt": "={{ $json.processedAt }}",
          "status": "OPEN",
          "escalationLevel": "={{ $json.severity === 'CRITICAL' ? 3 : $json.severity === 'HIGH' ? 2 : 1 }}"
        },
        "tableId": "threat_intelligence"
      },
      "name": "Store in Database",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        1100,
        200
      ],
      "credentials": {
        "postgres": {
          "id": "cybersentinel-db",
          "name": "CyberSentinel Database"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.webhookUrl }}",
        "options": {},
        "bodyParameters": {
          "parameters": [
            {
              "name": "threatType",
              "value": "={{ $json.threatType }}"
            },
            {
              "name": "threatId",
              "value": "={{ $json.threatId }}"
            },
            {
              "name": "severity",
              "value": "={{ $json.severity }}"
            },
            {
              "name": "title",
              "value": "={{ $json.title }}"
            },
            {
              "name": "description",
              "value": "={{ $json.description }}"
            },
            {
              "name": "cvss",
              "value": "={{ $json.cvss }}"
            },
            {
              "name": "affectedSystems",
              "value": "={{ JSON.stringify($json.affectedSystems) }}"
            },
            {
              "name": "recommendedActions",
              "value": "={{ JSON.stringify($json.recommendedActions) }}"
            },
            {
              "name": "n8nWorkflowId",
              "value": "cybersentinel-cve-alert-workflow-v1"
            }
          ]
        }
      },
      "name": "Trigger SOAR Playbook",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1300,
        200
      ]
    },
    {
      "parameters": {
        "interval": 86400
      },
      "name": "Daily Summary Schedule",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        100,
        400
      ]
    },
    {
      "parameters": {
        "operation": "query",
        "query": "SELECT COUNT(*) as total, SUM(CASE WHEN severity = 'CRITICAL' THEN 1 ELSE 0 END) as critical, SUM(CASE WHEN severity = 'HIGH' THEN 1 ELSE 0 END) as high FROM threat_intelligence WHERE processedAt > NOW() - INTERVAL '24 hours'"
      },
      "name": "Daily Stats Query",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        300,
        400
      ],
      "credentials": {
        "postgres": {
          "id": "cybersentinel-db",
          "name": "CyberSentinel Database"
        }
      }
    },
    {
      "parameters": {
        "channel": "security-reports",
        "blocks": [
          {
            "type": "section",
            "text": {
              "type": "mrkdwn",
              "text": "ðŸ“Š *Daily Threat Intelligence Summary*\n\n*Last 24 Hours:*\nâ€¢ Total CVEs Processed: {{ $json.total }}\nâ€¢ Critical: {{ $json.critical }}\nâ€¢ High: {{ $json.high }}\n\n_Automated report from CyberSentinel_"
            }
          }
        ]
      },
      "name": "Daily Summary Report",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [
        500,
        400
      ],
      "credentials": {
        "slackApi": {
          "id": "slack-security-alerts",
          "name": "Security Alerts Slack"
        }
      }
    }
  ],
  "connections": {
    "NVD CVE Feed Trigger": {
      "main": [
        [
          {
            "node": "Parse CVE Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CISA KEV Feed": {
      "main": [
        []
      ]
    },
    "Parse CVE Data": {
      "main": [
        [
          {
            "node": "Filter Critical CVEs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Critical CVEs": {
      "main": [
        [
          {
            "node": "Slack Alert - Critical",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Slack Alert - Standard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Slack Alert - Critical": {
      "main": [
        [
          {
            "node": "Store in Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Slack Alert - Standard": {
      "main": [
        [
          {
            "node": "Store in Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store in Database": {
      "main": [
        [
          {
            "node": "Trigger SOAR Playbook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Daily Summary Schedule": {
      "main": [
        [
          {
            "node": "Daily Stats Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Daily Stats Query": {
      "main": [
        [
          {
            "node": "Daily Summary Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}